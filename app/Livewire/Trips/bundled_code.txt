

=== File: TripDetails.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Log;

class TripDetails extends Component
{
    public $title;
    public $start_date;
    public $end_date;
    public $travelers = 4;
    public $budget;
    public $activityInterests = [];
    public $accommodationType;
    public $tripType;
    public $tripPace = 5;
    public $destination;

    public function mount()
    {
        // Set default dates (two weeks from now for one week)
        $this->start_date = now()->addWeeks(2)->format('Y-m-d');
        $this->end_date = now()->addWeeks(3)->format('Y-m-d');
        
        // Get destination from session
        $selectedDestination = session('selected_destination');
        
        if ($selectedDestination) {
            $this->destination = $selectedDestination['name'] ?? '';
            
            // Set default title based on destination
            if (empty($this->title) && isset($selectedDestination['name'])) {
                $this->title = "Trip to " . $selectedDestination['name'];
            }
        }
        
        // Load saved trip details if available
        $tripDetails = session('trip_details');
        if ($tripDetails) {
            $this->title = $tripDetails['title'] ?? $this->title;
            $this->start_date = $tripDetails['start_date'] ?? $this->start_date;
            $this->end_date = $tripDetails['end_date'] ?? $this->end_date;
            $this->travelers = $tripDetails['travelers'] ?? $this->travelers;
            $this->budget = $tripDetails['budget'] ?? $this->budget;
            $this->activityInterests = $tripDetails['activity_interests'] ?? $this->activityInterests;
            $this->accommodationType = $tripDetails['accommodation_type'] ?? $this->accommodationType;
            $this->tripType = $tripDetails['trip_type'] ?? $this->tripType;
            $this->tripPace = $tripDetails['trip_pace'] ?? $this->tripPace;
        }
    }

    public function render()
    {
        return view('livewire.trips.trip-details');
    }

    public function updated($field)
    {
        // Validate fields on change
        if (in_array($field, ['title', 'start_date', 'end_date', 'travelers', 'budget'])) {
            $this->validateOnly($field, $this->getValidationRules());
        }
    }

    public function getValidationRules()
    {
        return [
            'title' => 'required|string|max:255',
            'start_date' => 'required|date',
            'end_date' => 'required|date|after_or_equal:start_date',
            'travelers' => 'required|integer|min:1',
            'budget' => 'nullable|numeric|min:0',
            'activityInterests' => 'nullable|array',
            'accommodationType' => 'nullable|string',
            'tripType' => 'nullable|string',
            'tripPace' => 'nullable|integer|min:1|max:10',
        ];
    }

    public function saveTripDetails()
    {
        // Validate data
        $validatedData = $this->validate($this->getValidationRules());

        // Prepare data for session storage
        $tripDetails = [
            'title' => $this->title,
            'start_date' => $this->start_date,
            'end_date' => $this->end_date,
            'travelers' => $this->travelers,
            'budget' => $this->budget,
            'activity_interests' => $this->activityInterests,
            'accommodation_type' => $this->accommodationType,
            'trip_type' => $this->tripType,
            'trip_pace' => $this->tripPace,
        ];

        // Save to session
        session(['trip_details' => $tripDetails]);
        
        // Log for debugging
        Log::info("Trip Details saved, dispatching specific event to move to itinerary");
        
        // Use a specific named event instead of a generic one
        $this->dispatch('completeDetailsStep');
    }
}

=== File: TripTypeSelection.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use Illuminate\Support\Facades\Session;

class TripTypeSelection extends Component
{
    public function render()
    {
        return view('livewire.trips.trip-type-selection');
    }
    
    public function selectTripType($type)
    {
        if ($type === 'pre_planned' || $type === 'self_planned') {
            // Store the selected trip type in session
            Session::put('selected_trip_type', $type);
            
            // Dispatch event to parent component
            $this->dispatch('tripTypeSelected', tripType: $type);
        }
    }
}

=== File: CreateTrip.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Log;

class CreateTrip extends Component
{
    public $currentStep = 0; // Start at step 0 for trip type selection
    public $totalSteps = 5;
    public $showNavButtons = false;
    public $tripType = null;
    public $tripTemplateId = null;

    // Use specific events for each step transition
    protected $listeners = [
        'tripTypeSelected' => 'selectTripType',
        'tripTemplateSelected' => 'selectTripTemplate',
        'destinationSelected' => 'selectDestination',
        'completeDetailsStep' => 'moveToItinerary',
        'completeItineraryStep' => 'moveToInvites',
        'completeInvitesStep' => 'moveToReview',
        'goToPreviousStep' => 'previousStep'
    ];

    public function mount()
    {
        // Reset step to a for the trip type selection
        $this->currentStep = 0;

        // Check if we already have a trip type selected in session
        $this->tripType = session('selected_trip_type');
        $this->tripTemplateId = session('selected_trip_template');

        // If trip type is already selected, start at step 1 (destination or template selection)
        if ($this->tripType) {
            $this->currentStep = 1;
        }

        Log::info("CreateTrip component mounted with step: {$this->currentStep}, trip type: {$this->tripType}");
    }

    public function render()
    {
        // Debug info
        session(['debug_info' => "Current step: {$this->currentStep}, Trip type: {$this->tripType}"]);

        return view('livewire.trips.create-trip');
    }

    public function selectTripType($tripType)
    {
        $this->tripType = $tripType;
        Session::put('selected_trip_type', $tripType);

        $this->currentStep = 1; // Move to either destination selection or template selection

        Log::info("Trip type selected: {$tripType}, moved to step 1");
    }

    public function selectTripTemplate($tripTemplateId)
    {
        $this->tripTemplateId = $tripTemplateId;
        Session::put('selected_trip_template', $tripTemplateId);

        // Pre-planned trips skip steps 1-3 since the template already has them
        // Move directly to invites (step 4)
        $this->currentStep = 4;

        Log::info("Trip template selected: {$tripTemplateId}, moved to step 4 (invites)");
    }

    public function selectDestination($destination)
    {
        // Store destination (for self-planned trips)
        Session::put('selected_destination', $destination);

        // Go to Trip Details
        $oldStep = $this->currentStep;
        $this->currentStep = 2;
        Log::info("Selected destination, moved from step {$oldStep} to 2");
    }

    // Specific transition methods for each step
    public function moveToItinerary()
    {
        Log::info("Moving to Itinerary (step 3) from step: {$this->currentStep}");
        $this->currentStep = 3;
    }

    public function moveToInvites()
    {
        Log::info("Moving to Invites (step 4) from step: {$this->currentStep}");
        $this->currentStep = 4;
    }

    public function moveToReview()
    {
        Log::info("Moving to Review (step 5) from step: {$this->currentStep}");
        $this->currentStep = 5;
    }

    public function previousStep()
    {
        $oldStep = $this->currentStep;

        // Special handling for pre-planned trips
        if ($this->tripType === 'pre_planned' && $this->currentStep === 4) {
            // Go back to template selection
            $this->currentStep = 1;
        } else if ($this->currentStep > 0) {
            // Normal step backwards
            $this->currentStep--;
        }

        Log::info("Moved back from step {$oldStep} to {$this->currentStep}");
    }

    public function goToStep($step)
    {
        $oldStep = $this->currentStep;

        // Only allow valid steps and consider trip type
        if ($step >= 0 && $step <= $this->totalSteps) {
            // For pre-planned trips, only allow steps 0, 1, 4 and 5
            if ($this->tripType === 'pre_planned') {
                if ($step == 0 || $step == 1 || $step == 4 || $step == 5) {
                    $this->currentStep = $step;
                    Log::info("Manually navigated from step {$oldStep} to {$this->currentStep}");
                }
            }
            // For self-planned trips or initial selection, allow normal flow
            else {
                // Only allow backward navigation or one step forward
                if ($step < $this->currentStep || $step == $this->currentStep + 1) {
                    $this->currentStep = $step;
                    Log::info("Manually navigated from step {$oldStep} to {$this->currentStep}");
                }
            }
        }
    }

    public function skipToSummary()
    {
        $oldStep = $this->currentStep;

        if ($this->tripType === 'pre_planned' && $this->tripTemplateId) {
            $this->currentStep = $this->totalSteps; // Go to review
            Log::info("Skipped from step {$oldStep} to summary (step 5) for pre-planned trip");
        } else if ($this->tripType === 'self_planned' && session('selected_destination') && session('trip_details')) {
            $this->currentStep = $this->totalSteps; // Go to review
            Log::info("Skipped from step {$oldStep} to summary (step 5) for self-planned trip");
        }
    }

    /**
     * Handle the create trip button click
     * Saves trip data to session and redirects to login
     */
    public function createTrip()
    {
        // Mark session data as "new" so it will be saved after login
        session(['trip_data_not_saved' => true]);

        // Log session data before redirect
        Log::info('Trip data before redirect to login', [
            'trip_data_not_saved' => session('trip_data_not_saved'),
            'selected_trip_type' => session('selected_trip_type'),
            'selected_destination' => session('selected_destination'),
            'trip_details' => session('trip_details'),
            'session_id' => session()->getId()
        ]);

        // Flash message for login/register page
        session()->flash('message', 'Please login or create an account to save your trip plans.');

        // Check if user is authenticated
        if (auth()->check()) {
            // User is already logged in, redirect to trips.index
            return redirect()->route('trips.index');
        } else {
            // User is not logged in, redirect to login
            return redirect()->route('login');
        }

        // Ensure total cost and budget are properly set in session
        $tripDetails = session('trip_details', []);
        $totalPrice = session('trip_total_price', 0);

        // Make sure we have a total cost value
        if (!isset($tripDetails['total_cost'])) {
            if ($totalPrice > 0) {
                $tripDetails['total_cost'] = $totalPrice;
            } elseif (isset($tripDetails['budget'])) {
                $tripDetails['total_cost'] = $tripDetails['budget'];
            } else {
                $tripDetails['total_cost'] = 0;
            }

            // Make sure budget is at least equal to total cost
            if (!isset($tripDetails['budget']) || $tripDetails['budget'] < $tripDetails['total_cost']) {
                $tripDetails['budget'] = $tripDetails['total_cost'];
            }

            session(['trip_details' => $tripDetails]);
        }

        // Log session data before redirect
        Log::info('Trip data before redirect to login', [
            'trip_data_not_saved' => session('trip_data_not_saved'),
            'selected_trip_type' => session('selected_trip_type'),
            'selected_destination' => session('selected_destination'),
            'trip_details' => session('trip_details'),
            'selected_optional_activities' => session('selected_optional_activities'),
            'trip_total_price' => session('trip_total_price'),
            'session_id' => session()->getId()
        ]);

        // Add a flash message for the login/register page
        session()->flash('message', 'Please login or create an account to save your trip plans.');

        // Check if user is authenticated
        if (auth()->check()) {
            // User is already logged in, redirect to trips index for middleware to handle
            return redirect()->route('trips.index');
        } else {
            // User is not logged in, redirect to login
            return redirect()->route('login');
        }
    }
}


=== File: Review.php ===

<?php

namespace App\Livewire\Trips;

use App\Models\TripTemplate;
use Illuminate\Support\Facades\Session;
use Livewire\Component;

class Review extends Component
{
    public $tripType;
    public $destination;
    public $tripDetails;
    public $tripActivities;
    public $invites;
    public $tripTemplate;
    public $templateActivities;
    public $templateHighlights;
    public $selectedOptionalActivities = [];
    public $optionalActivities = [];
    public $basePrice;
    public $totalCost;

    public function mount()
    {
        $this->tripType = session('selected_trip_type');
        $this->destination = session('selected_destination');
        $this->tripDetails = session('trip_details', []);
        $this->tripActivities = session('trip_activities', []);
        $this->invites = session('trip_invites', []);

        // If pre-planned trip, get template details
        if ($this->tripType === 'pre_planned') {
            $templateId = session('selected_trip_template');
            if ($templateId) {
                $this->tripTemplate = TripTemplate::with(['activities', 'destination'])->find($templateId);

                if ($this->tripTemplate) {
                    // Parse the highlights JSON field if it exists
                    if ($this->tripTemplate->highlights) {
                        // Check if highlights is already an array
                        $this->templateHighlights = is_array($this->tripTemplate->highlights)
                            ? $this->tripTemplate->highlights
                            : json_decode($this->tripTemplate->highlights, true) ?? [];
                    } else {
                        $this->templateHighlights = [];
                    }

                    // Get base price
                    $this->basePrice = $this->tripTemplate->base_price;

                    // Get optional activities
                    $this->optionalActivities = $this->tripTemplate->activities()
                        ->where('is_optional', true)
                        ->get();

                    // Get selected optional activities from session
                    $this->selectedOptionalActivities = session('selected_optional_activities', []);

                    // Try to get total price from session first
                    $this->totalCost = session('trip_total_price', $this->basePrice);

                    // If no total price in session, calculate it
                    if ($this->totalCost == $this->basePrice && !empty($this->selectedOptionalActivities)) {
                        foreach ($this->selectedOptionalActivities as $id => $activity) {
                            if (isset($activity['cost'])) {
                                $this->totalCost += $activity['cost'];
                            }
                        }
                    }

                    // Make sure trip details has the correct total cost
                    if ((!isset($this->tripDetails['total_cost']) || $this->tripDetails['total_cost'] != $this->totalCost)) {
                        $this->tripDetails['total_cost'] = $this->totalCost;
                        session(['trip_details' => $this->tripDetails]);
                    }

                    // Group activities by day (only non-optional)
                    $activities = $this->tripTemplate->activities()
                        ->where('is_optional', false)
                        ->get();

                    $groupedActivities = [];

                    foreach ($activities as $activity) {
                        $groupedActivities[$activity->day_number][] = $activity;
                    }

                    // Sort activities by start_time for each day
                    foreach ($groupedActivities as $day => $dayActivities) {
                        usort($dayActivities, function ($a, $b) {
                            return $a->start_time <=> $b->start_time;
                        });

                        $groupedActivities[$day] = $dayActivities;
                    }

                    $this->templateActivities = $groupedActivities;
                }
            }
        }
    }

    public function render()
    {
        return view('livewire.trips.review');
    }

    public function editTripType()
    {
        $this->dispatch('goToStep', step: 0);
    }

    public function editDestination()
    {
        $this->dispatch('goToStep', step: 1);
    }

    public function editDetails()
    {
        $this->dispatch('goToStep', step: 2);
    }

    public function editItinerary()
    {
        $this->dispatch('goToStep', step: 3);
    }

    public function editInvites()
    {
        $this->dispatch('goToStep', step: 4);
    }
}


=== File: DestinationSelection.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use App\Models\Destination;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Session;

class DestinationSelection extends Component
{
    public $destinationQuery = '';
    public $showDestinationDropdown = false;
    public $destinationResults = [];
    public $recentSearches = [];
    public $popularDestinations = [];
   
    public function mount()
    {
        // Load popular destinations from database
        $this->loadPopularDestinations();
        
        // Load recent searches if available
        $this->loadRecentSearches();
    }

    public function render()
    {
        return view('livewire.trips.destination-selection');
    }

    public function searchDestinations()
    {
        if (strlen($this->destinationQuery) >= 2) {
            $this->destinationResults = Destination::where('name', 'like', '%' . $this->destinationQuery . '%')
                ->orWhere('country', 'like', '%' . $this->destinationQuery . '%')
                ->orWhere('city', 'like', '%' . $this->destinationQuery . '%')
                ->take(5)
                ->get()
                ->toArray();

            $this->showDestinationDropdown = true;
        } else {
            $this->resetDestinationResults();
        }
    }

    public function resetDestinationResults()
    {
        $this->destinationResults = [];
        $this->showDestinationDropdown = false;
    }
    
    public function selectDestination($name)
    {
        $destination = Destination::where('name', $name)->first();
        
        if ($destination) {
            // Store destination in session for persistence
            Session::put('selected_destination', $destination->toArray());
            
            // Add to recent searches if authenticated
            $this->saveRecentSearch($destination);
            
            // Dispatch event to parent component
            $this->dispatch('destinationSelected', destination: $destination->toArray());
        }
        
        $this->resetDestinationResults();
    }

    private function loadPopularDestinations()
    {
        // In a real implementation, you might load trending or featured destinations
        // For now, we'll just get a random selection
        $this->popularDestinations = Destination::inRandomOrder()->take(6)->get();
    }

    private function loadRecentSearches()
    {
        // Get recent searches from session if authenticated
        if (Auth::check()) {
            $this->recentSearches = Session::get('recent_searches', []);
        } else {
            $this->recentSearches = []; // Ensure it's always an array
        }
    }

    private function saveRecentSearch($destination)
    {
        if (Auth::check()) {
            $recentSearches = Session::get('recent_searches', []);
            
            // Check if already in recent searches
            $exists = false;
            foreach ($recentSearches as $search) {
                if (isset($search['id']) && $search['id'] == $destination->id) {
                    $exists = true;
                    break;
                }
            }
            
            // Add to recent searches if not already present
            if (!$exists) {
                array_unshift($recentSearches, $destination->toArray());
                // Keep only last 4 searches
                $recentSearches = array_slice($recentSearches, 0, 4);
                Session::put('recent_searches', $recentSearches);
                $this->recentSearches = $recentSearches;
            }
        }
    }
}

=== File: ItineraryPlanning.php ===

<?php

namespace App\Livewire\Trips;

use App\Models\TripTemplate;
use Livewire\Component;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class ItineraryPlanning extends Component
{
    public $destination;
    public $tripTitle;
    public $startDate;
    public $endDate;
    public $budget;
    public $basePrice;
    public $totalCost;
    public $travelers;
    public $activeDay = 1;
    public $dayActivities = [];
    public $totalDays;
    public $tripTemplate;
    public $optionalActivities = [];
    public $selectedOptionalActivities = [];
    
    // For new activities
    public $newActivity = [
        'title' => '',
        'description' => '',
        'location' => '',
        'start_time' => '09:00',
        'end_time' => '12:00',
        'cost' => '',
        'category' => '',
        'time_of_day' => 'morning'
    ];
    
    // Invited friends
    public $inviteEmails = [];
    
    // Suggested activities
    public $suggestedActivities = [];
    
    public function mount()
    {
        // Get trip details from session
        $selectedDestination = session('selected_destination');
        $tripDetails = session('trip_details');
        $tripInvites = session('trip_invites');
        $templateId = session('selected_trip_template');
        
        if ($selectedDestination) {
            $this->destination = $selectedDestination['name'] ?? '';
        }
        
        if ($tripDetails) {
            $this->tripTitle = $tripDetails['title'] ?? '';
            $this->startDate = $tripDetails['start_date'] ?? '';
            $this->endDate = $tripDetails['end_date'] ?? '';
            $this->budget = $tripDetails['budget'] ?? '';
            $this->travelers = $tripDetails['travelers'] ?? 4;
            
            // Calculate total days
            if ($this->startDate && $this->endDate) {
                $start = Carbon::parse($this->startDate);
                $end = Carbon::parse($this->endDate);
                $this->totalDays = $start->diffInDays($end) + 1; // Include start & end days
            }
        }
        
        if ($tripInvites) {
            $this->inviteEmails = $tripInvites;
        }
        
        // Get trip template if this is a pre-planned trip
        if ($templateId) {
            $this->tripTemplate = TripTemplate::with(['activities' => function($query) {
                $query->where('is_optional', false);
            }])->find($templateId);
            
            // Get optional activities
            if ($this->tripTemplate) {
                $this->basePrice = $this->tripTemplate->base_price;
                $this->budget = $this->basePrice;
                $this->totalCost = $this->basePrice;
                
                // Get optional activities
                $this->optionalActivities = $this->tripTemplate->activities()
                    ->where('is_optional', true)
                    ->get();
                    
                // Load any previously selected optional activities
                $selectedOptActivities = session('selected_optional_activities', []);
                if (!empty($selectedOptActivities)) {
                    $this->selectedOptionalActivities = $selectedOptActivities;
                    
                    // Recalculate total cost
                    foreach ($this->selectedOptionalActivities as $activityId) {
                        $activity = $this->optionalActivities->firstWhere('id', $activityId);
                        if ($activity) {
                            $this->totalCost += $activity->cost;
                        }
                    }
                }
            }
        }
        
        // Load saved activities if available
        $savedActivities = session('trip_activities');
        if ($savedActivities) {
            $this->dayActivities = $savedActivities;
        } else {
            // Initialize empty activities for each day
            for ($i = 1; $i <= $this->totalDays; $i++) {
                $this->dayActivities[$i] = [];
            }
        }
        
        // Load some suggested activities
        $this->loadSuggestedActivities();
    }

    public function render()
    {
        return view('livewire.trips.itinerary-planning');
    }
    
    public function changeActiveDay($day)
    {
        if ($day >= 1 && $day <= $this->totalDays) {
            $this->activeDay = $day;
        }
    }
    
    public function addActivity()
    {
        $this->validate([
            'newActivity.title' => 'required|string|max:255',
            'newActivity.time_of_day' => 'required|in:morning,afternoon,evening',
            'newActivity.start_time' => 'required',
            'newActivity.end_time' => 'required',
            'newActivity.location' => 'required|string',
            'newActivity.cost' => 'nullable|numeric|min:0',
            'newActivity.category' => 'required|string',
        ]);
        
        // Generate a unique ID for the activity
        $id = uniqid();
        
        // Add to current day's activities
        $this->dayActivities[$this->activeDay][] = array_merge($this->newActivity, ['id' => $id]);
        
        // Update total cost if cost is provided
        if (!empty($this->newActivity['cost']) && is_numeric($this->newActivity['cost'])) {
            $this->totalCost += floatval($this->newActivity['cost']);
            
            // Update budget if needed
            if ($this->totalCost > $this->budget) {
                $this->budget = $this->totalCost;
            }
        }
        
        // Save to session
        session(['trip_activities' => $this->dayActivities]);
        
        // Reset form
        $this->resetNewActivity();
        
        // Close modal
        $this->dispatch('closeAddActivityModal');
    }
    
    public function resetNewActivity()
    {
        $this->newActivity = [
            'title' => '',
            'description' => '',
            'location' => '',
            'start_time' => '09:00',
            'end_time' => '12:00',
            'cost' => '',
            'category' => '',
            'time_of_day' => 'morning'
        ];
    }
    
    public function removeActivity($day, $activityId)
    {
        if (isset($this->dayActivities[$day])) {
            // Get activity cost before removing
            $activityCost = 0;
            foreach ($this->dayActivities[$day] as $activity) {
                if ($activity['id'] === $activityId && isset($activity['cost'])) {
                    $activityCost = floatval($activity['cost']);
                    break;
                }
            }
            
            // Remove activity
            $this->dayActivities[$day] = array_filter($this->dayActivities[$day], function($activity) use ($activityId) {
                return $activity['id'] !== $activityId;
            });
            
            // Re-index array
            $this->dayActivities[$day] = array_values($this->dayActivities[$day]);
            
            // Update total cost
            $this->totalCost -= $activityCost;
            
            // Save to session
            session(['trip_activities' => $this->dayActivities]);
        }
    }
    
    public function toggleOptionalActivity($activityId)
    {
        // Find activity in optional activities
        $activity = $this->optionalActivities->firstWhere('id', $activityId);
        
        if (!$activity) return;
        
        // Check if already selected
        $index = array_search($activityId, $this->selectedOptionalActivities);
        
        if ($index !== false) {
            // Remove from selected activities
            unset($this->selectedOptionalActivities[$index]);
            $this->selectedOptionalActivities = array_values($this->selectedOptionalActivities);
            
            // Subtract cost
            $this->totalCost -= $activity->cost;
        } else {
            // Add to selected activities
            $this->selectedOptionalActivities[] = $activityId;
            
            // Add cost
            $this->totalCost += $activity->cost;
            
            // Update budget if needed
            if ($this->totalCost > $this->budget) {
                $this->budget = $this->totalCost;
            }
        }
        
        // Save selected optional activities to session
        session(['selected_optional_activities' => $this->selectedOptionalActivities]);
    }
    
    public function updateBudget()
    {
        // Validate budget
        $this->validate([
            'budget' => 'required|numeric|min:' . $this->totalCost,
        ], [
            'budget.min' => 'Budget cannot be less than the total cost of selected activities ($' . number_format($this->totalCost, 2) . ')'
        ]);
        
        // Save the budget to session
        if ($tripDetails = session('trip_details')) {
            $tripDetails['budget'] = $this->budget;
            session(['trip_details' => $tripDetails]);
        } else {
            session(['trip_details' => [
                'budget' => $this->budget
            ]]);
        }
    }
    
    public function addSuggestedActivity($index)
    {
        $suggestion = $this->suggestedActivities[$index] ?? null;
        
        if ($suggestion) {
            // Determine time of day based on activity type
            $timeOfDay = 'afternoon'; // Default
            if (stripos($suggestion['title'], 'breakfast') !== false || 
                stripos($suggestion['title'], 'morning') !== false) {
                $timeOfDay = 'morning';
            } elseif (stripos($suggestion['title'], 'dinner') !== false || 
                      stripos($suggestion['title'], 'sunset') !== false || 
                      stripos($suggestion['title'], 'night') !== false || 
                      stripos($suggestion['title'], 'evening') !== false) {
                $timeOfDay = 'evening';
            }
            
            // Set appropriate times based on time of day
            $startTime = $timeOfDay === 'morning' ? '09:00' : ($timeOfDay === 'afternoon' ? '14:00' : '19:00');
            $endTime = $timeOfDay === 'morning' ? '12:00' : ($timeOfDay === 'afternoon' ? '17:00' : '21:00');
            
            // Add to current day's activities
            $this->dayActivities[$this->activeDay][] = [
                'id' => uniqid(),
                'title' => $suggestion['title'],
                'description' => $suggestion['description'],
                'location' => $suggestion['location'],
                'start_time' => $startTime,
                'end_time' => $endTime,
                'cost' => $suggestion['cost'],
                'category' => $suggestion['category'],
                'time_of_day' => $timeOfDay
            ];
            
            // Update total cost
            $this->totalCost += floatval($suggestion['cost']);
            
            // Update budget if needed
            if ($this->totalCost > $this->budget) {
                $this->budget = $this->totalCost;
            }
            
            // Save to session
            session(['trip_activities' => $this->dayActivities]);
        }
    }
    
    private function loadSuggestedActivities()
    {
        // In a real app, these would come from a database based on the destination
        $this->suggestedActivities = [
            [
                'id' => 'sugg1',
                'title' => 'Local City Tour',
                'location' => $this->destination,
                'description' => 'Explore the highlights of ' . $this->destination . ' with a knowledgeable local guide.',
                'cost' => 45,
                'category' => 'cultural'
            ],
            [
                'id' => 'sugg2',
                'title' => 'Beach Day',
                'location' => 'Popular Beach in ' . $this->destination,
                'description' => 'Relax by the ocean, swim, and enjoy beach activities.',
                'cost' => 10,
                'category' => 'relaxation'
            ],
            [
                'id' => 'sugg3',
                'title' => 'Local Food Tour',
                'location' => 'Market District in ' . $this->destination,
                'description' => 'Taste the local cuisine and discover hidden food gems.',
                'cost' => 55,
                'category' => 'food'
            ],
            [
                'id' => 'sugg4',
                'title' => 'Sunset Cruise',
                'location' => 'Harbor area in ' . $this->destination,
                'description' => 'Enjoy a beautiful sunset from the water with drinks and snacks.',
                'cost' => 75,
                'category' => 'adventure'
            ]
        ];
    }
    
    public function continueToNextStep()
    {
        // Save budget and total cost to session
        if ($tripDetails = session('trip_details')) {
            $tripDetails['budget'] = $this->budget;
            $tripDetails['total_cost'] = $this->totalCost;
            session(['trip_details' => $tripDetails]);
        } else {
            session(['trip_details' => [
                'budget' => $this->budget,
                'total_cost' => $this->totalCost
            ]]);
        }
        
        // Save activities to session
        session(['trip_activities' => $this->dayActivities]);
        
        // Log for debugging
        Log::info("Itinerary planning saved, dispatching specific event to move to invites");
        
        // Use a specific named event
        $this->dispatch('completeItineraryStep');
    }
}

=== File: bundled_code.txt ===



=== File: TripDetails.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Log;

class TripDetails extends Component
{
    public $title;
    public $start_date;
    public $end_date;
    public $travelers = 4;
    public $budget;
    public $activityInterests = [];
    public $accommodationType;
    public $tripType;
    public $tripPace = 5;
    public $destination;

    public function mount()
    {
        // Set default dates (two weeks from now for one week)
        $this->start_date = now()->addWeeks(2)->format('Y-m-d');
        $this->end_date = now()->addWeeks(3)->format('Y-m-d');
        
        // Get destination from session
        $selectedDestination = session('selected_destination');
        
        if ($selectedDestination) {
            $this->destination = $selectedDestination['name'] ?? '';
            
            // Set default title based on destination
            if (empty($this->title) && isset($selectedDestination['name'])) {
                $this->title = "Trip to " . $selectedDestination['name'];
            }
        }
        
        // Load saved trip details if available
        $tripDetails = session('trip_details');
        if ($tripDetails) {
            $this->title = $tripDetails['title'] ?? $this->title;
            $this->start_date = $tripDetails['start_date'] ?? $this->start_date;
            $this->end_date = $tripDetails['end_date'] ?? $this->end_date;
            $this->travelers = $tripDetails['travelers'] ?? $this->travelers;
            $this->budget = $tripDetails['budget'] ?? $this->budget;
            $this->activityInterests = $tripDetails['activity_interests'] ?? $this->activityInterests;
            $this->accommodationType = $tripDetails['accommodation_type'] ?? $this->accommodationType;
            $this->tripType = $tripDetails['trip_type'] ?? $this->tripType;
            $this->tripPace = $tripDetails['trip_pace'] ?? $this->tripPace;
        }
    }

    public function render()
    {
        return view('livewire.trips.trip-details');
    }

    public function updated($field)
    {
        // Validate fields on change
        if (in_array($field, ['title', 'start_date', 'end_date', 'travelers', 'budget'])) {
            $this->validateOnly($field, $this->getValidationRules());
        }
    }

    public function getValidationRules()
    {
        return [
            'title' => 'required|string|max:255',
            'start_date' => 'required|date',
            'end_date' => 'required|date|after_or_equal:start_date',
            'travelers' => 'required|integer|min:1',
            'budget' => 'nullable|numeric|min:0',
            'activityInterests' => 'nullable|array',
            'accommodationType' => 'nullable|string',
            'tripType' => 'nullable|string',
            'tripPace' => 'nullable|integer|min:1|max:10',
        ];
    }

    public function saveTripDetails()
    {
        // Validate data
        $validatedData = $this->validate($this->getValidationRules());

        // Prepare data for session storage
        $tripDetails = [
            'title' => $this->title,
            'start_date' => $this->start_date,
            'end_date' => $this->end_date,
            'travelers' => $this->travelers,
            'budget' => $this->budget,
            'activity_interests' => $this->activityInterests,
            'accommodation_type' => $this->accommodationType,
            'trip_type' => $this->tripType,
            'trip_pace' => $this->tripPace,
        ];

        // Save to session
        session(['trip_details' => $tripDetails]);
        
        // Log for debugging
        Log::info("Trip Details saved, dispatching specific event to move to itinerary");
        
        // Use a specific named event instead of a generic one
        $this->dispatch('completeDetailsStep');
    }
}

=== File: TripTypeSelection.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use Illuminate\Support\Facades\Session;

class TripTypeSelection extends Component
{
    public function render()
    {
        return view('livewire.trips.trip-type-selection');
    }
    
    public function selectTripType($type)
    {
        if ($type === 'pre_planned' || $type === 'self_planned') {
            // Store the selected trip type in session
            Session::put('selected_trip_type', $type);
            
            // Dispatch event to parent component
            $this->dispatch('tripTypeSelected', tripType: $type);
        }
    }
}

=== File: CreateTrip.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Log;

class CreateTrip extends Component
{
    public $currentStep = 0; // Start at step 0 for trip type selection
    public $totalSteps = 5;
    public $showNavButtons = false;
    public $tripType = null;
    public $tripTemplateId = null;

    // Use specific events for each step transition
    protected $listeners = [
        'tripTypeSelected' => 'selectTripType',
        'tripTemplateSelected' => 'selectTripTemplate',
        'destinationSelected' => 'selectDestination',
        'completeDetailsStep' => 'moveToItinerary',
        'completeItineraryStep' => 'moveToInvites',
        'completeInvitesStep' => 'moveToReview',
        'goToPreviousStep' => 'previousStep'
    ];

    public function mount()
    {
        // Reset step to a for the trip type selection
        $this->currentStep = 0;

        // Check if we already have a trip type selected in session
        $this->tripType = session('selected_trip_type');
        $this->tripTemplateId = session('selected_trip_template');

        // If trip type is already selected, start at step 1 (destination or template selection)
        if ($this->tripType) {
            $this->currentStep = 1;
        }

        Log::info("CreateTrip component mounted with step: {$this->currentStep}, trip type: {$this->tripType}");
    }

    public function render()
    {
        // Debug info
        session(['debug_info' => "Current step: {$this->currentStep}, Trip type: {$this->tripType}"]);

        return view('livewire.trips.create-trip');
    }

    public function selectTripType($tripType)
    {
        $this->tripType = $tripType;
        Session::put('selected_trip_type', $tripType);

        $this->currentStep = 1; // Move to either destination selection or template selection

        Log::info("Trip type selected: {$tripType}, moved to step 1");
    }

    public function selectTripTemplate($tripTemplateId)
    {
        $this->tripTemplateId = $tripTemplateId;
        Session::put('selected_trip_template', $tripTemplateId);

        // Pre-planned trips skip steps 1-3 since the template already has them
        // Move directly to invites (step 4)
        $this->currentStep = 4;

        Log::info("Trip template selected: {$tripTemplateId}, moved to step 4 (invites)");
    }

    public function selectDestination($destination)
    {
        // Store destination (for self-planned trips)
        Session::put('selected_destination', $destination);

        // Go to Trip Details
        $oldStep = $this->currentStep;
        $this->currentStep = 2;
        Log::info("Selected destination, moved from step {$oldStep} to 2");
    }

    // Specific transition methods for each step
    public function moveToItinerary()
    {
        Log::info("Moving to Itinerary (step 3) from step: {$this->currentStep}");
        $this->currentStep = 3;
    }

    public function moveToInvites()
    {
        Log::info("Moving to Invites (step 4) from step: {$this->currentStep}");
        $this->currentStep = 4;
    }

    public function moveToReview()
    {
        Log::info("Moving to Review (step 5) from step: {$this->currentStep}");
        $this->currentStep = 5;
    }

    public function previousStep()
    {
        $oldStep = $this->currentStep;

        // Special handling for pre-planned trips
        if ($this->tripType === 'pre_planned' && $this->currentStep === 4) {
            // Go back to template selection
            $this->currentStep = 1;
        } else if ($this->currentStep > 0) {
            // Normal step backwards
            $this->currentStep--;
        }

        Log::info("Moved back from step {$oldStep} to {$this->currentStep}");
    }

    public function goToStep($step)
    {
        $oldStep = $this->currentStep;

        // Only allow valid steps and consider trip type
        if ($step >= 0 && $step <= $this->totalSteps) {
            // For pre-planned trips, only allow steps 0, 1, 4 and 5
            if ($this->tripType === 'pre_planned') {
                if ($step == 0 || $step == 1 || $step == 4 || $step == 5) {
                    $this->currentStep = $step;
                    Log::info("Manually navigated from step {$oldStep} to {$this->currentStep}");
                }
            }
            // For self-planned trips or initial selection, allow normal flow
            else {
                // Only allow backward navigation or one step forward
                if ($step < $this->currentStep || $step == $this->currentStep + 1) {
                    $this->currentStep = $step;
                    Log::info("Manually navigated from step {$oldStep} to {$this->currentStep}");
                }
            }
        }
    }

    public function skipToSummary()
    {
        $oldStep = $this->currentStep;

        if ($this->tripType === 'pre_planned' && $this->tripTemplateId) {
            $this->currentStep = $this->totalSteps; // Go to review
            Log::info("Skipped from step {$oldStep} to summary (step 5) for pre-planned trip");
        } else if ($this->tripType === 'self_planned' && session('selected_destination') && session('trip_details')) {
            $this->currentStep = $this->totalSteps; // Go to review
            Log::info("Skipped from step {$oldStep} to summary (step 5) for self-planned trip");
        }
    }

    /**
     * Handle the create trip button click
     * Saves trip data to session and redirects to login
     */
    public function createTrip()
    {
        // Mark session data as "new" so it will be saved after login
        session(['trip_data_not_saved' => true]);

        // Log session data before redirect
        Log::info('Trip data before redirect to login', [
            'trip_data_not_saved' => session('trip_data_not_saved'),
            'selected_trip_type' => session('selected_trip_type'),
            'selected_destination' => session('selected_destination'),
            'trip_details' => session('trip_details'),
            'session_id' => session()->getId()
        ]);

        // Flash message for login/register page
        session()->flash('message', 'Please login or create an account to save your trip plans.');

        // Check if user is authenticated
        if (auth()->check()) {
            // User is already logged in, redirect to trips.index
            return redirect()->route('trips.index');
        } else {
            // User is not logged in, redirect to login
            return redirect()->route('login');
        }

        // Ensure total cost and budget are properly set in session
        $tripDetails = session('trip_details', []);
        $totalPrice = session('trip_total_price', 0);

        // Make sure we have a total cost value
        if (!isset($tripDetails['total_cost'])) {
            if ($totalPrice > 0) {
                $tripDetails['total_cost'] = $totalPrice;
            } elseif (isset($tripDetails['budget'])) {
                $tripDetails['total_cost'] = $tripDetails['budget'];
            } else {
                $tripDetails['total_cost'] = 0;
            }

            // Make sure budget is at least equal to total cost
            if (!isset($tripDetails['budget']) || $tripDetails['budget'] < $tripDetails['total_cost']) {
                $tripDetails['budget'] = $tripDetails['total_cost'];
            }

            session(['trip_details' => $tripDetails]);
        }

        // Log session data before redirect
        Log::info('Trip data before redirect to login', [
            'trip_data_not_saved' => session('trip_data_not_saved'),
            'selected_trip_type' => session('selected_trip_type'),
            'selected_destination' => session('selected_destination'),
            'trip_details' => session('trip_details'),
            'selected_optional_activities' => session('selected_optional_activities'),
            'trip_total_price' => session('trip_total_price'),
            'session_id' => session()->getId()
        ]);

        // Add a flash message for the login/register page
        session()->flash('message', 'Please login or create an account to save your trip plans.');

        // Check if user is authenticated
        if (auth()->check()) {
            // User is already logged in, redirect to trips index for middleware to handle
            return redirect()->route('trips.index');
        } else {
            // User is not logged in, redirect to login
            return redirect()->route('login');
        }
    }
}


=== File: Review.php ===

<?php

namespace App\Livewire\Trips;

use App\Models\TripTemplate;
use Illuminate\Support\Facades\Session;
use Livewire\Component;

class Review extends Component
{
    public $tripType;
    public $destination;
    public $tripDetails;
    public $tripActivities;
    public $invites;
    public $tripTemplate;
    public $templateActivities;
    public $templateHighlights;
    public $selectedOptionalActivities = [];
    public $optionalActivities = [];
    public $basePrice;
    public $totalCost;

    public function mount()
    {
        $this->tripType = session('selected_trip_type');
        $this->destination = session('selected_destination');
        $this->tripDetails = session('trip_details', []);
        $this->tripActivities = session('trip_activities', []);
        $this->invites = session('trip_invites', []);

        // If pre-planned trip, get template details
        if ($this->tripType === 'pre_planned') {
            $templateId = session('selected_trip_template');
            if ($templateId) {
                $this->tripTemplate = TripTemplate::with(['activities', 'destination'])->find($templateId);

                if ($this->tripTemplate) {
                    // Parse the highlights JSON field if it exists
                    if ($this->tripTemplate->highlights) {
                        // Check if highlights is already an array
                        $this->templateHighlights = is_array($this->tripTemplate->highlights)
                            ? $this->tripTemplate->highlights
                            : json_decode($this->tripTemplate->highlights, true) ?? [];
                    } else {
                        $this->templateHighlights = [];
                    }

                    // Get base price
                    $this->basePrice = $this->tripTemplate->base_price;

                    // Get optional activities
                    $this->optionalActivities = $this->tripTemplate->activities()
                        ->where('is_optional', true)
                        ->get();

                    // Get selected optional activities from session
                    $this->selectedOptionalActivities = session('selected_optional_activities', []);

                    // Try to get total price from session first
                    $this->totalCost = session('trip_total_price', $this->basePrice);

                    // If no total price in session, calculate it
                    if ($this->totalCost == $this->basePrice && !empty($this->selectedOptionalActivities)) {
                        foreach ($this->selectedOptionalActivities as $id => $activity) {
                            if (isset($activity['cost'])) {
                                $this->totalCost += $activity['cost'];
                            }
                        }
                    }

                    // Make sure trip details has the correct total cost
                    if ((!isset($this->tripDetails['total_cost']) || $this->tripDetails['total_cost'] != $this->totalCost)) {
                        $this->tripDetails['total_cost'] = $this->totalCost;
                        session(['trip_details' => $this->tripDetails]);
                    }

                    // Group activities by day (only non-optional)
                    $activities = $this->tripTemplate->activities()
                        ->where('is_optional', false)
                        ->get();

                    $groupedActivities = [];

                    foreach ($activities as $activity) {
                        $groupedActivities[$activity->day_number][] = $activity;
                    }

                    // Sort activities by start_time for each day
                    foreach ($groupedActivities as $day => $dayActivities) {
                        usort($dayActivities, function ($a, $b) {
                            return $a->start_time <=> $b->start_time;
                        });

                        $groupedActivities[$day] = $dayActivities;
                    }

                    $this->templateActivities = $groupedActivities;
                }
            }
        }
    }

    public function render()
    {
        return view('livewire.trips.review');
    }

    public function editTripType()
    {
        $this->dispatch('goToStep', step: 0);
    }

    public function editDestination()
    {
        $this->dispatch('goToStep', step: 1);
    }

    public function editDetails()
    {
        $this->dispatch('goToStep', step: 2);
    }

    public function editItinerary()
    {
        $this->dispatch('goToStep', step: 3);
    }

    public function editInvites()
    {
        $this->dispatch('goToStep', step: 4);
    }
}


=== File: DestinationSelection.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use App\Models\Destination;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Session;

class DestinationSelection extends Component
{
    public $destinationQuery = '';
    public $showDestinationDropdown = false;
    public $destinationResults = [];
    public $recentSearches = [];
    public $popularDestinations = [];
   
    public function mount()
    {
        // Load popular destinations from database
        $this->loadPopularDestinations();
        
        // Load recent searches if available
        $this->loadRecentSearches();
    }

    public function render()
    {
        return view('livewire.trips.destination-selection');
    }

    public function searchDestinations()
    {
        if (strlen($this->destinationQuery) >= 2) {
            $this->destinationResults = Destination::where('name', 'like', '%' . $this->destinationQuery . '%')
                ->orWhere('country', 'like', '%' . $this->destinationQuery . '%')
                ->orWhere('city', 'like', '%' . $this->destinationQuery . '%')
                ->take(5)
                ->get()
                ->toArray();

            $this->showDestinationDropdown = true;
        } else {
            $this->resetDestinationResults();
        }
    }

    public function resetDestinationResults()
    {
        $this->destinationResults = [];
        $this->showDestinationDropdown = false;
    }
    
    public function selectDestination($name)
    {
        $destination = Destination::where('name', $name)->first();
        
        if ($destination) {
            // Store destination in session for persistence
            Session::put('selected_destination', $destination->toArray());
            
            // Add to recent searches if authenticated
            $this->saveRecentSearch($destination);
            
            // Dispatch event to parent component
            $this->dispatch('destinationSelected', destination: $destination->toArray());
        }
        
        $this->resetDestinationResults();
    }

    private function loadPopularDestinations()
    {
        // In a real implementation, you might load trending or featured destinations
        // For now, we'll just get a random selection
        $this->popularDestinations = Destination::inRandomOrder()->take(6)->get();
    }

    private function loadRecentSearches()
    {
        // Get recent searches from session if authenticated
        if (Auth::check()) {
            $this->recentSearches = Session::get('recent_searches', []);
        } else {
            $this->recentSearches = []; // Ensure it's always an array
        }
    }

    private function saveRecentSearch($destination)
    {
        if (Auth::check()) {
            $recentSearches = Session::get('recent_searches', []);
            
            // Check if already in recent searches
            $exists = false;
            foreach ($recentSearches as $search) {
                if (isset($search['id']) && $search['id'] == $destination->id) {
                    $exists = true;
                    break;
                }
            }
            
            // Add to recent searches if not already present
            if (!$exists) {
                array_unshift($recentSearches, $destination->toArray());
                // Keep only last 4 searches
                $recentSearches = array_slice($recentSearches, 0, 4);
                Session::put('recent_searches', $recentSearches);
                $this->recentSearches = $recentSearches;
            }
        }
    }
}

=== File: ItineraryPlanning.php ===

<?php

namespace App\Livewire\Trips;

use App\Models\TripTemplate;
use Livewire\Component;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class ItineraryPlanning extends Component
{
    public $destination;
    public $tripTitle;
    public $startDate;
    public $endDate;
    public $budget;
    public $basePrice;
    public $totalCost;
    public $travelers;
    public $activeDay = 1;
    public $dayActivities = [];
    public $totalDays;
    public $tripTemplate;
    public $optionalActivities = [];
    public $selectedOptionalActivities = [];
    
    // For new activities
    public $newActivity = [
        'title' => '',
        'description' => '',
        'location' => '',
        'start_time' => '09:00',
        'end_time' => '12:00',
        'cost' => '',
        'category' => '',
        'time_of_day' => 'morning'
    ];
    
    // Invited friends
    public $inviteEmails = [];
    
    // Suggested activities
    public $suggestedActivities = [];
    
    public function mount()
    {
        // Get trip details from session
        $selectedDestination = session('selected_destination');
        $tripDetails = session('trip_details');
        $tripInvites = session('trip_invites');
        $templateId = session('selected_trip_template');
        
        if ($selectedDestination) {
            $this->destination = $selectedDestination['name'] ?? '';
        }
        
        if ($tripDetails) {
            $this->tripTitle = $tripDetails['title'] ?? '';
            $this->startDate = $tripDetails['start_date'] ?? '';
            $this->endDate = $tripDetails['end_date'] ?? '';
            $this->budget = $tripDetails['budget'] ?? '';
            $this->travelers = $tripDetails['travelers'] ?? 4;
            
            // Calculate total days
            if ($this->startDate && $this->endDate) {
                $start = Carbon::parse($this->startDate);
                $end = Carbon::parse($this->endDate);
                $this->totalDays = $start->diffInDays($end) + 1; // Include start & end days
            }
        }
        
        if ($tripInvites) {
            $this->inviteEmails = $tripInvites;
        }
        
        // Get trip template if this is a pre-planned trip
        if ($templateId) {
            $this->tripTemplate = TripTemplate::with(['activities' => function($query) {
                $query->where('is_optional', false);
            }])->find($templateId);
            
            // Get optional activities
            if ($this->tripTemplate) {
                $this->basePrice = $this->tripTemplate->base_price;
                $this->budget = $this->basePrice;
                $this->totalCost = $this->basePrice;
                
                // Get optional activities
                $this->optionalActivities = $this->tripTemplate->activities()
                    ->where('is_optional', true)
                    ->get();
                    
                // Load any previously selected optional activities
                $selectedOptActivities = session('selected_optional_activities', []);
                if (!empty($selectedOptActivities)) {
                    $this->selectedOptionalActivities = $selectedOptActivities;
                    
                    // Recalculate total cost
                    foreach ($this->selectedOptionalActivities as $activityId) {
                        $activity = $this->optionalActivities->firstWhere('id', $activityId);
                        if ($activity) {
                            $this->totalCost += $activity->cost;
                        }
                    }
                }
            }
        }
        
        // Load saved activities if available
        $savedActivities = session('trip_activities');
        if ($savedActivities) {
            $this->dayActivities = $savedActivities;
        } else {
            // Initialize empty activities for each day
            for ($i = 1; $i <= $this->totalDays; $i++) {
                $this->dayActivities[$i] = [];
            }
        }
        
        // Load some suggested activities
        $this->loadSuggestedActivities();
    }

    public function render()
    {
        return view('livewire.trips.itinerary-planning');
    }
    
    public function changeActiveDay($day)
    {
        if ($day >= 1 && $day <= $this->totalDays) {
            $this->activeDay = $day;
        }
    }
    
    public function addActivity()
    {
        $this->validate([
            'newActivity.title' => 'required|string|max:255',
            'newActivity.time_of_day' => 'required|in:morning,afternoon,evening',
            'newActivity.start_time' => 'required',
            'newActivity.end_time' => 'required',
            'newActivity.location' => 'required|string',
            'newActivity.cost' => 'nullable|numeric|min:0',
            'newActivity.category' => 'required|string',
        ]);
        
        // Generate a unique ID for the activity
        $id = uniqid();
        
        // Add to current day's activities
        $this->dayActivities[$this->activeDay][] = array_merge($this->newActivity, ['id' => $id]);
        
        // Update total cost if cost is provided
        if (!empty($this->newActivity['cost']) && is_numeric($this->newActivity['cost'])) {
            $this->totalCost += floatval($this->newActivity['cost']);
            
            // Update budget if needed
            if ($this->totalCost > $this->budget) {
                $this->budget = $this->totalCost;
            }
        }
        
        // Save to session
        session(['trip_activities' => $this->dayActivities]);
        
        // Reset form
        $this->resetNewActivity();
        
        // Close modal
        $this->dispatch('closeAddActivityModal');
    }
    
    public function resetNewActivity()
    {
        $this->newActivity = [
            'title' => '',
            'description' => '',
            'location' => '',
            'start_time' => '09:00',
            'end_time' => '12:00',
            'cost' => '',
            'category' => '',
            'time_of_day' => 'morning'
        ];
    }
    
    public function removeActivity($day, $activityId)
    {
        if (isset($this->dayActivities[$day])) {
            // Get activity cost before removing
            $activityCost = 0;
            foreach ($this->dayActivities[$day] as $activity) {
                if ($activity['id'] === $activityId && isset($activity['cost'])) {
                    $activityCost = floatval($activity['cost']);
                    break;
                }
            }
            
            // Remove activity
            $this->dayActivities[$day] = array_filter($this->dayActivities[$day], function($activity) use ($activityId) {
                return $activity['id'] !== $activityId;
            });
            
            // Re-index array
            $this->dayActivities[$day] = array_values($this->dayActivities[$day]);
            
            // Update total cost
            $this->totalCost -= $activityCost;
            
            // Save to session
            session(['trip_activities' => $this->dayActivities]);
        }
    }
    
    public function toggleOptionalActivity($activityId)
    {
        // Find activity in optional activities
        $activity = $this->optionalActivities->firstWhere('id', $activityId);
        
        if (!$activity) return;
        
        // Check if already selected
        $index = array_search($activityId, $this->selectedOptionalActivities);
        
        if ($index !== false) {
            // Remove from selected activities
            unset($this->selectedOptionalActivities[$index]);
            $this->selectedOptionalActivities = array_values($this->selectedOptionalActivities);
            
            // Subtract cost
            $this->totalCost -= $activity->cost;
        } else {
            // Add to selected activities
            $this->selectedOptionalActivities[] = $activityId;
            
            // Add cost
            $this->totalCost += $activity->cost;
            
            // Update budget if needed
            if ($this->totalCost > $this->budget) {
                $this->budget = $this->totalCost;
            }
        }
        
        // Save selected optional activities to session
        session(['selected_optional_activities' => $this->selectedOptionalActivities]);
    }
    
    public function updateBudget()
    {
        // Validate budget
        $this->validate([
            'budget' => 'required|numeric|min:' . $this->totalCost,
        ], [
            'budget.min' => 'Budget cannot be less than the total cost of selected activities ($' . number_format($this->totalCost, 2) . ')'
        ]);
        
        // Save the budget to session
        if ($tripDetails = session('trip_details')) {
            $tripDetails['budget'] = $this->budget;
            session(['trip_details' => $tripDetails]);
        } else {
            session(['trip_details' => [
                'budget' => $this->budget
            ]]);
        }
    }
    
    public function addSuggestedActivity($index)
    {
        $suggestion = $this->suggestedActivities[$index] ?? null;
        
        if ($suggestion) {
            // Determine time of day based on activity type
            $timeOfDay = 'afternoon'; // Default
            if (stripos($suggestion['title'], 'breakfast') !== false || 
                stripos($suggestion['title'], 'morning') !== false) {
                $timeOfDay = 'morning';
            } elseif (stripos($suggestion['title'], 'dinner') !== false || 
                      stripos($suggestion['title'], 'sunset') !== false || 
                      stripos($suggestion['title'], 'night') !== false || 
                      stripos($suggestion['title'], 'evening') !== false) {
                $timeOfDay = 'evening';
            }
            
            // Set appropriate times based on time of day
            $startTime = $timeOfDay === 'morning' ? '09:00' : ($timeOfDay === 'afternoon' ? '14:00' : '19:00');
            $endTime = $timeOfDay === 'morning' ? '12:00' : ($timeOfDay === 'afternoon' ? '17:00' : '21:00');
            
            // Add to current day's activities
            $this->dayActivities[$this->activeDay][] = [
                'id' => uniqid(),
                'title' => $suggestion['title'],
                'description' => $suggestion['description'],
                'location' => $suggestion['location'],
                'start_time' => $startTime,
                'end_time' => $endTime,
                'cost' => $suggestion['cost'],
                'category' => $suggestion['category'],
                'time_of_day' => $timeOfDay
            ];
            
            // Update total cost
            $this->totalCost += floatval($suggestion['cost']);
            
            // Update budget if needed
            if ($this->totalCost > $this->budget) {
                $this->budget = $this->totalCost;
            }
            
            // Save to session
            session(['trip_activities' => $this->dayActivities]);
        }
    }
    
    private function loadSuggestedActivities()
    {
        // In a real app, these would come from a database based on the destination
        $this->suggestedActivities = [
            [
                'id' => 'sugg1',
                'title' => 'Local City Tour',
                'location' => $this->destination,
                'description' => 'Explore the highlights of ' . $this->destination . ' with a knowledgeable local guide.',
                'cost' => 45,
                'category' => 'cultural'
            ],
            [
                'id' => 'sugg2',
                'title' => 'Beach Day',
                'location' => 'Popular Beach in ' . $this->destination,
                'description' => 'Relax by the ocean, swim, and enjoy beach activities.',
                'cost' => 10,
                'category' => 'relaxation'
            ],
            [
                'id' => 'sugg3',
                'title' => 'Local Food Tour',
                'location' => 'Market District in ' . $this->destination,
                'description' => 'Taste the local cuisine and discover hidden food gems.',
                'cost' => 55,
                'category' => 'food'
            ],
            [
                'id' => 'sugg4',
                'title' => 'Sunset Cruise',
                'location' => 'Harbor area in ' . $this->destination,
                'description' => 'Enjoy a beautiful sunset from the water with drinks and snacks.',
                'cost' => 75,
                'category' => 'adventure'
            ]
        ];
    }
    
    public function continueToNextStep()
    {
        // Save budget and total cost to session
        if ($tripDetails = session('trip_details')) {
            $tripDetails['budget'] = $this->budget;
            $tripDetails['total_cost'] = $this->totalCost;
            session(['trip_details' => $tripDetails]);
        } else {
            session(['trip_details' => [
                'budget' => $this->budget,
                'total_cost' => $this->totalCost
            ]]);
        }
        
        // Save activities to session
        session(['trip_activities' => $this->dayActivities]);
        
        // Log for debugging
        Log::info("Itinerary planning saved, dispatching specific event to move to invites");
        
        // Use a specific named event
        $this->dispatch('completeItineraryStep');
    }
}

=== File: InviteFriends.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Log;

class InviteFriends extends Component
{
    public $destination;
    public $tripTitle;
    public $startDate;
    public $endDate;
    public $travelers = 1; // Default to 1 (just the organizer)
    
    public $friendName = '';
    public $friendContact = '';
    public $personalMessage = '';
    public $inviteEmails = [];
    public $showBudget = true;  // For toggling budget visibility
    public $showBulkInvite = false;
    public $bulkEmails = '';
    public $bulkMessage = '';
    
    public function mount()
    {
        // Get trip details from session
        $selectedDestination = session('selected_destination');
        $tripDetails = session('trip_details');
        
        if ($selectedDestination) {
            $this->destination = $selectedDestination['name'] ?? '';
        }
        
        if ($tripDetails) {
            $this->tripTitle = $tripDetails['title'] ?? '';
            $this->startDate = $tripDetails['start_date'] ?? '';
            $this->endDate = $tripDetails['end_date'] ?? '';
            // Only set $travelers from session if it's a valid number greater than 0
            if (isset($tripDetails['travelers']) && $tripDetails['travelers'] > 0) {
                $this->travelers = $tripDetails['travelers'];
            }
        }
        
        // Load saved invites if available
        $savedInvites = session('trip_invites');
        if ($savedInvites) {
            $this->inviteEmails = $savedInvites;
        }
    }

    public function render()
    {
        return view('livewire.trips.invite-friends');
    }
    
    public function addInvite()
    {
        $this->validate([
            'friendName' => 'required|string|max:255',
            'friendContact' => 'required|email',
        ]);
        
        // Add to invite list
        $this->inviteEmails[] = [
            'name' => $this->friendName,
            'email' => $this->friendContact,
            'message' => $this->personalMessage,
            'status' => 'pending'
        ];
        
        // Reset form fields
        $this->reset(['friendName', 'friendContact', 'personalMessage']);
        
        // Save to session
        session(['trip_invites' => $this->inviteEmails]);
    }
    
    public function removeInvite($index)
    {
        if (isset($this->inviteEmails[$index])) {
            // Remove the invite at the specified index
            unset($this->inviteEmails[$index]);
            
            // Re-index array
            $this->inviteEmails = array_values($this->inviteEmails);
            
            // Save to session
            session(['trip_invites' => $this->inviteEmails]);
        }
    }
    
    public function processBulkInvite()
    {
        $this->validate([
            'bulkEmails' => 'required|string',
        ]);
        
        // Split by comma, semicolon, or new line
        $emails = preg_split('/[\s,;]+/', $this->bulkEmails);
        $validEmails = [];
        
        foreach ($emails as $email) {
            $email = trim($email);
            
            if (filter_var($email, FILTER_VALIDATE_EMAIL)) {
                $validEmails[] = [
                    'name' => '',  // No name for bulk invites
                    'email' => $email,
                    'message' => $this->bulkMessage,
                    'status' => 'pending'
                ];
            }
        }
        
        // Add to invite list
        $this->inviteEmails = array_merge($this->inviteEmails, $validEmails);
        
        // Reset form fields
        $this->reset(['bulkEmails', 'bulkMessage', 'showBulkInvite']);
        
        // Save to session
        session(['trip_invites' => $this->inviteEmails]);
        
        $this->dispatch('closeBulkInviteModal');
    }
    
    public function continueToNextStep()
    {
        // Calculate and update total travelers (organizer + invited)
        $totalTravelers = 1 + count($this->inviteEmails);
        
        // Update trip details in session
        $tripDetails = session('trip_details', []);
        $tripDetails['travelers'] = $totalTravelers;
        session(['trip_details' => $tripDetails]);
        
        // Save invites to session
        session(['trip_invites' => $this->inviteEmails]);
        
        // Log for debugging
        Log::info("Invites saved, dispatching specific event to move to review");
        
        // Use a specific named event
        $this->dispatch('completeInvitesStep');
    }
}

=== File: PrePlannedTripSelection.php ===

<?php

namespace App\Livewire\Trips;

use App\Models\Destination;
use App\Models\TripTemplate;
use App\Models\TemplateActivity;
use Illuminate\Support\Facades\Session;
use Livewire\Component;

class PrePlannedTripSelection extends Component
{
    public $destinations = [];
    public $selectedDestination = null;
    public $tripTemplates = [];
    public $selectedTemplate = null;
    public $showTemplateDetails = false;
    public $templateActivities = [];
    public $templateHighlights = [];
    public $optionalActivities = [];
    
    // New properties for optional activities selection
    public $selectedOptionalActivities = [];
    public $totalPrice = 0;

    public function mount()
    {
        $this->destinations = Destination::has('tripTemplates')->get();
    }

    public function render()
    {
        return view('livewire.trips.pre-planned-trip-selection');
    }

    public function selectDestination($destinationId)
    {
        $this->selectedDestination = Destination::find($destinationId);
        $this->tripTemplates = TripTemplate::where('destination_id', $destinationId)
            ->with('destination')
            ->get();

        // Reset template selection
        $this->selectedTemplate = null;
        $this->showTemplateDetails = false;
        $this->templateActivities = [];
        $this->templateHighlights = [];
        $this->selectedOptionalActivities = [];
        $this->totalPrice = 0;
    }

    protected function getListeners()
    {
        return [
            'viewTemplate' => 'handleViewTemplate',
        ];
    }

    public function handleViewTemplate($data)
    {
        \Illuminate\Support\Facades\Log::info('handleViewTemplate called with data: ', $data);
        $this->viewTemplateDetails($data['templateId']);
    }

    public function viewTemplateDetails($templateId)
    {
        // Debug information
        \Illuminate\Support\Facades\Log::info('viewTemplateDetails called with ID: ' . $templateId);

        $this->selectedTemplate = TripTemplate::with(['activities', 'destination'])->find($templateId);
        $this->showTemplateDetails = true;

        // Reset selected optional activities
        $this->selectedOptionalActivities = [];
        
        // Set initial total price to base price
        $this->totalPrice = $this->selectedTemplate->base_price;

        // Parse the highlights field if it exists
if ($this->selectedTemplate->highlights) {
    // Check if highlights is already an array
    $this->templateHighlights = is_array($this->selectedTemplate->highlights) 
        ? $this->selectedTemplate->highlights 
        : json_decode($this->selectedTemplate->highlights, true) ?? [];
} else {
    $this->templateHighlights = [];
}

        // Group activities by day and separate optional activities
        $activities = $this->selectedTemplate->activities;
        $groupedActivities = [];
        $optionalActivities = [];

        foreach ($activities as $activity) {
            if ($activity->is_optional) {
                $optionalActivities[] = $activity;
            } else {
                $groupedActivities[$activity->day_number][] = $activity;
            }
        }

        // Sort activities by start_time for each day
        foreach ($groupedActivities as $day => $dayActivities) {
            usort($dayActivities, function ($a, $b) {
                return $a->start_time <=> $b->start_time;
            });

            $groupedActivities[$day] = $dayActivities;
        }

        $this->templateActivities = $groupedActivities;
        $this->optionalActivities = $optionalActivities;
    }

    // Toggle optional activity selection
    public function toggleOptionalActivity($activityId)
    {
        if (isset($this->selectedOptionalActivities[$activityId])) {
            // If already selected, remove it
            $activityCost = $this->selectedOptionalActivities[$activityId]['cost'];
            $this->totalPrice -= $activityCost;
            unset($this->selectedOptionalActivities[$activityId]);
        } else {
            // If not selected, add it
            $activity = TemplateActivity::find($activityId);
            if ($activity) {
                $this->selectedOptionalActivities[$activityId] = [
                    'id' => $activity->id,
                    'title' => $activity->title,
                    'cost' => $activity->cost
                ];
                $this->totalPrice += $activity->cost;
            }
        }
        
        // Debug information
        \Illuminate\Support\Facades\Log::info('Optional activity toggled. New total price: ' . $this->totalPrice);
        \Illuminate\Support\Facades\Log::info('Selected optional activities: ', $this->selectedOptionalActivities);
    }

    public function selectTripTemplate()
    {
        if (!$this->selectedTemplate) {
            return;
        }

        // Store template selection in session
        Session::put('selected_trip_template', $this->selectedTemplate->id);
        Session::put('selected_destination', [
            'id' => $this->selectedDestination->id,
            'name' => $this->selectedDestination->name,
            'country' => $this->selectedDestination->country,
            'city' => $this->selectedDestination->city,
        ]);

        // Store price information and selected optional activities in session
        Session::put('trip_base_price', $this->selectedTemplate->base_price);
        Session::put('selected_optional_activities', $this->selectedOptionalActivities);
        Session::put('trip_total_price', $this->totalPrice);
        
        // Update trip details with total price
        $tripDetails = Session::get('trip_details', []);
        $tripDetails['total_cost'] = $this->totalPrice;
        $tripDetails['budget'] = max($tripDetails['budget'] ?? 0, $this->totalPrice);
        Session::put('trip_details', $tripDetails);

        // Dispatch event to parent component
        $this->dispatch('tripTemplateSelected', tripTemplateId: $this->selectedTemplate->id);
    }

    public function backToTemplates()
    {
        $this->showTemplateDetails = false;
    }

    public function backToDestinations()
    {
        $this->selectedDestination = null;
        $this->tripTemplates = [];
    }
}

=== File: TripList.php ===

<?php

namespace App\Livewire\Trips;

use Livewire\Component;
use App\Models\Trip;
use Illuminate\Support\Facades\Auth;

class TripList extends Component
{
    public $trips;

    public function mount()
    {
        $this->loadTrips();
    }

    public function render()
    {
        return view('livewire.trips.index');
    }

    private function loadTrips()
    {
        $user = Auth::user();
        
        // Get trips where the user is the creator or a member
        $this->trips = Trip::where('creator_id', $user->id)
            ->orWhereHas('members', function($query) use ($user) {
                $query->where('user_id', $user->id);
            })
            ->orderBy('created_at', 'desc')
            ->get();
    }
}